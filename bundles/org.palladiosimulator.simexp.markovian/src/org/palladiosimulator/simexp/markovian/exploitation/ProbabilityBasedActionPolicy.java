package org.palladiosimulator.simexp.markovian.exploitation;

import java.util.HashSet;
import java.util.Optional;
import java.util.Set;

import org.palladiosimulator.simexp.markovian.access.MarkovModelAccessor;
import org.palladiosimulator.simexp.markovian.activity.Policy;
import org.palladiosimulator.simexp.markovian.exploration.RandomizedStrategy;
import org.palladiosimulator.simexp.markovian.model.markovmodel.markoventity.Action;
import org.palladiosimulator.simexp.markovian.model.markovmodel.markoventity.MarkovModel;
import org.palladiosimulator.simexp.markovian.model.markovmodel.markoventity.State;
import org.palladiosimulator.simexp.markovian.model.markovmodel.markoventity.Transition;

public class ProbabilityBasedActionPolicy<T> implements Policy<Action<T>> {

	private final static String POLICY_NAME = "ProbabilityBasedActionSelection";
	
	private final Optional<MarkovModelAccessor<Action<T>>> markovAccessor;
	
	public ProbabilityBasedActionPolicy(Optional<MarkovModel<T>> markovModel) {
		if (markovModel.isPresent()) {
			this.markovAccessor = Optional.of(MarkovModelAccessor.of(markovModel.get()));
		} else {
			this.markovAccessor = Optional.empty();
		}
	}
	

	@Override
	public String getId() {
		return POLICY_NAME;
	}
	
	@Override
	public Action<T> select(State<Action<T>> source, Set<Action<T>> options) {
		if (markovAccessor.isPresent()) {
			return selectAccordingToModel(source, options);
		}
		return selectRandomly(options);
	}


	private Action<T> selectAccordingToModel(State<Action<T>> source, Set<Action<T>> options) {
		return new ProbabilityBasedTransitionPolicy().select(source, filterTransitions(source, options)).getLabel();
	}

	private Set<Transition<Action<T>>> filterTransitions(State<Action<T>> source, Set<Action<T>> options) {
		Set<Transition<Action<T>>> results = new HashSet<>();
		for (Action<T> each : options) {
			//TODO exception handling
			Transition<Action<T>> result = markovAccessor.get().findTransition(source, each)
													.orElseThrow(() -> new RuntimeException(""));
			results.add(result);
		}
		return results;
	}

	private Action<T> selectRandomly(Set<Action<T>> options) {
		return new RandomizedStrategy<Action<T>>().select(null, options);
	}
	
}
