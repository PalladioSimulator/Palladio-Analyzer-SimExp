/*
 * generated by Xtext 2.26.0
 */
package org.palladiosimulator.simexp.dsl.kmodel.tests

import com.google.inject.Inject
import org.eclipse.xtext.testing.InjectWith
import org.eclipse.xtext.testing.extensions.InjectionExtension
import org.eclipse.xtext.testing.util.ParseHelper
import org.junit.jupiter.api.Assertions
import org.junit.jupiter.api.Test
import org.junit.jupiter.api.^extension.ExtendWith
import org.palladiosimulator.simexp.dsl.kmodel.kmodel.KModel
import org.palladiosimulator.simexp.dsl.kmodel.kmodel.Statement
import org.palladiosimulator.simexp.dsl.kmodel.kmodel.Variable
import org.palladiosimulator.simexp.dsl.kmodel.kmodel.DataType
import org.eclipse.xtext.testing.validation.ValidationTestHelper

@ExtendWith(InjectionExtension)
@InjectWith(KmodelInjectorProvider)
class KmodelParsingTest {
	@Inject
	ParseHelper<KModel> parseHelper
	
	@Inject 
	ValidationTestHelper validationTestHelper
	
	@Test
	def void singleIntegerTest() {
		val result = parseHelper.parse('''
			var int a;
		''')
		Assertions.assertNotNull(result)
		val errors = result.eResource.errors
		Assertions.assertTrue(errors.isEmpty, '''Unexpected errors: «errors.join(", ")»''')
		
		Assertions.assertEquals(result.elements.length, 1)
		val variable = (result.elements.head as Statement).^var as Variable
		Assertions.assertEquals(variable.dataType, DataType.INT)
		Assertions.assertEquals(variable.name, "a")
	}
	
	@Test
	def void singleFloatTest() {
		val result = parseHelper.parse('''
			var float a;
		''')
		Assertions.assertNotNull(result)
		val errors = result.eResource.errors
		Assertions.assertTrue(errors.isEmpty, '''Unexpected errors: «errors.join(", ")»''')
		
		Assertions.assertEquals(result.elements.length, 1)
		val variable = (result.elements.head as Statement).^var as Variable
		Assertions.assertEquals(variable.dataType, DataType.FLOAT)
		Assertions.assertEquals(variable.name, "a")
	}
	
	@Test
	def void singleBooleanTest() {
		val result = parseHelper.parse('''
			var bool a;
		''')
		Assertions.assertNotNull(result)
		val errors = result.eResource.errors
		Assertions.assertTrue(errors.isEmpty, '''Unexpected errors: «errors.join(", ")»''')
		
		Assertions.assertEquals(result.elements.length, 1)
		val variable = (result.elements.head as Statement).^var as Variable
		Assertions.assertEquals(variable.dataType, DataType.BOOL)
		Assertions.assertEquals(variable.name, "a")
	}
	
	@Test
	def void singleStringTest() {
		val result = parseHelper.parse('''
			var string a;
		''')
		Assertions.assertNotNull(result)
		val errors = result.eResource.errors
		Assertions.assertTrue(errors.isEmpty, '''Unexpected errors: «errors.join(", ")»''')
		
		Assertions.assertEquals(result.elements.length, 1)
		val variable = (result.elements.head as Statement).^var as Variable
		Assertions.assertEquals(variable.dataType, DataType.STRING)
		Assertions.assertEquals(variable.name, "a")
	}
	
	@Test
	def void doubleVariableTest() {
		val result = parseHelper.parse('''
			var int a;
			var bool b;
		''')

		val errors = result.eResource.errors
		Assertions.assertTrue(errors.isEmpty, '''Unexpected errors: «errors.join(", ")»''')
		Assertions.assertEquals(result.elements.length, 2)
		val iterator = result.elements.iterator
		val firstVariable = (iterator.next as Statement).^var as Variable
		Assertions.assertEquals(firstVariable.dataType, DataType.INT)
		Assertions.assertEquals(firstVariable.name, "a")
		val secondVariable = (iterator.next as Statement).^var as Variable
		Assertions.assertEquals(secondVariable.dataType, DataType.BOOL)
		Assertions.assertEquals(secondVariable.name, "b")
	}
	
	@Test
	def void noTypeTest() {
		val result = parseHelper.parse('''
			var a;
		''')
		
		val errors = result.eResource.errors
		Assertions.assertEquals(1, errors.length);
		Assertions.assertEquals("no viable alternative at input 'a'", errors.get(0).message);
	}
	
	@Test
	def void invalidTypeTest() {
		val result = parseHelper.parse('''
			var something a;
		''')
		
		val errors = result.eResource.errors
		Assertions.assertEquals(2, errors.length);
		Assertions.assertEquals("no viable alternative at input 'something'", errors.get(0).message);
		Assertions.assertEquals("extraneous input 'a' expecting ';'", errors.get(1).message);
	}
	
	@Test
	def void noNameTest() {
		val result = parseHelper.parse('''
			var float;
		''')
		
		val errors = result.eResource.errors
		Assertions.assertEquals(1, errors.length);
		Assertions.assertEquals("missing RULE_ID at ';'", errors.get(0).message);
	}
	
	@Test
	def void numberAsNameTest() {
		val result = parseHelper.parse('''
			var int 1;
		''')
		
		val errors = result.eResource.errors
		Assertions.assertEquals(1, errors.length);
		Assertions.assertEquals("mismatched input '1' expecting RULE_ID", errors.get(0).message);
	}
	
	@Test
	def void symbolAsNameTest() {
		val result = parseHelper.parse('''
			var bool ?;
		''')

		val errors = result.eResource.errors
		Assertions.assertEquals(1, errors.length);
		Assertions.assertEquals("mismatched input '?' expecting RULE_ID", errors.get(0).message);
	}
	
	@Test
	def void keywordAsNameTest() {
		val result = parseHelper.parse('''
			var string var;
		''')

		val errors = result.eResource.errors
		Assertions.assertEquals(1, errors.length);
		Assertions.assertEquals("mismatched input 'var' expecting RULE_ID", errors.get(0).message);
	}
	
	@Test
	def void typeAsNameTest() {
		val result = parseHelper.parse('''
			var int bool;
		''')

		val errors = result.eResource.errors
		Assertions.assertEquals(1, errors.length);
		Assertions.assertEquals("mismatched input 'bool' expecting RULE_ID", errors.get(0).message);
	}
	
	@Test
	def void sameNameTest() {
		val result = parseHelper.parse('''
			var string a;
			var float a;
		''')
		
		val errors = result.eResource.errors
		Assertions.assertTrue(errors.isEmpty, '''Unexpected errors: «errors.join(", ")»''')
		val issues = validationTestHelper.validate(result)
		Assertions.assertEquals(issues.length, 2)
		Assertions.assertEquals(issues.get(0).message, "Duplicate Variable 'a'")
		Assertions.assertEquals(issues.get(0).lineNumber, 1)
		Assertions.assertEquals(issues.get(1).message, "Duplicate Variable 'a'")
		Assertions.assertEquals(issues.get(1).lineNumber, 2)
	}
}
